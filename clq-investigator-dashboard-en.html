<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jabatan Tenaga Kerja Semenanjung Malaysia (JTKSM) ‚Äì Risk-Based Central Labour Quarters Investigation Portal (Prototype)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- Top Navigation -->
  <header class="bg-white shadow flex items-center justify-between px-6 py-3">
    <div class="flex items-center space-x-2">
      <img src="./jata-negara.png" alt="Coat of Arms of Malaysia" style="height:60px;width:60px;object-fit:contain;border-radius:60%;background:#fff;padding:4px;" />
      <div>
        <h1 class="text-lg font-semibold text-gray-800">
          Jabatan Tenaga Kerja Semenanjung Malaysia (JTKSM) ‚Äì Risk-Based Central Labour Quarters Investigation Portal
        </h1>
        <p class="text-xs text-gray-500">Prototype ‚Äì For Demonstration Purposes Only</p>
      </div>
    </div>

    <div class="flex items-center space-x-4">
      <button class="relative" aria-label="Notifications">
        <span class="text-gray-500">üîî</span>
        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] rounded-full w-4 h-4 flex items-center justify-center">3</span>
      </button>

      <div class="flex items-center space-x-2">
        <img src="./investigator.png" alt="Coat of Arms of Malaysia" style="height:60px;width:60px;object-fit:contain;border-radius:60%;background:#fff;padding:4px;" />
        <div class="text-sm">
          <p class="font-medium text-gray-800">Aina binti Ahmad</p>
          <p class="text-xs text-gray-500">Investigator Officer</p>
        </div>
      </div>
    </div>
  </header>

  <div class="flex">
    <!-- Sidebar -->
    <aside class="w-60 bg-white border-r min-h-screen">
      <nav class="mt-4">
        <a href="#"
           class="flex items-center px-5 py-2 text-sm font-medium text-blue-600 bg-blue-50 border-l-4 border-blue-600">
          Dashboard
        </a>
        <a href="#"
           class="flex items-center px-5 py-2 text-sm text-gray-600 hover:bg-gray-50">
          CLQ List
        </a>
        <a href="#"
           class="flex items-center px-5 py-2 text-sm text-gray-600 hover:bg-gray-50">
          Worker Complaints
        </a>
        <a href="#"
           class="flex items-center px-5 py-2 text-sm text-gray-600 hover:bg-gray-50">
          Reports & Analytics
        </a>
        <a href="#"
           class="flex items-center px-5 py-2 text-sm text-gray-600 hover:bg-gray-50">
          Settings
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 space-y-6">
      <!-- Title + Filters -->
      <section class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold text-gray-800">
            Risk-Based Investigation Dashboard ‚Äì CLQ
          </h2>
          <p class="text-sm text-gray-500">
            Predictive signals help prioritise CLQs for investigation under Act 446. Final decisions remain with officers.
          </p>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <select id="filterState"
                  class="border border-gray-300 text-sm rounded px-2 py-1 bg-white">
            <option value="">All States</option>
            <option value="JOHOR">JOHOR</option>
            <option value="SELANGOR">SELANGOR</option>
            <option value="KEDAH">KEDAH</option>
            <option value="PULAU PINANG">PULAU PINANG</option>
          </select>

          <select id="filterRisk"
                  class="border border-gray-300 text-sm rounded px-2 py-1 bg-white">
            <option value="">All Risk Levels</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>

          <button id="btnApplyFilter"
                  class="bg-blue-600 text-white text-sm px-4 py-1.5 rounded shadow hover:bg-blue-700">
            Generate Priority List
          </button>
        </div>
      </section>

      <!-- Summary Cards -->
      <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow-sm p-4">
          <p class="text-xs text-gray-500 uppercase">Registered CLQs</p>
          <p id="cardTotalClq" class="mt-2 text-2xl font-semibold text-gray-800">-</p>
          <p class="text-xs text-gray-400">In the current view</p>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-4">
          <p class="text-xs text-gray-500 uppercase">High-Risk CLQs</p>
          <p id="cardHighRisk" class="mt-2 text-2xl font-semibold text-red-600">-</p>
          <p class="text-xs text-gray-400">Flagged by predictive signals</p>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-4">
          <p class="text-xs text-gray-500 uppercase">Investigations Scheduled</p>
          <p class="mt-2 text-2xl font-semibold text-gray-800">18</p>
          <p class="text-xs text-gray-400">December 2025</p>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-4">
          <p class="text-xs text-gray-500 uppercase">Complaints (Last 60 Days)</p>
          <p id="cardComplaints" class="mt-2 text-2xl font-semibold text-orange-500">-</p>
          <p class="text-xs text-gray-400">Related to worker accommodation</p>
        </div>
      </section>

      <!-- Table + Detail Panel -->
      <section class="grid grid-cols-1 xl:grid-cols-3 gap-4">
        <!-- Table -->
        <div class="xl:col-span-2 bg-white rounded-lg shadow-sm p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-800">
              Investigation Priority List<br>
		<font class="text-xs text-gray-400">*Risk scores are produced by a simplified predictive scoring model for decision support.</font>
            </h3>
            <!-- <p class="text-xs text-gray-400">
              *Risk scores are produced by a simplified predictive scoring model for decision support.
            </p>-->
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-xs md:text-sm border-t border-gray-100">
              <thead class="bg-gray-50 text-gray-600">
                <tr>
                  <th class="px-3 py-2 text-left">#</th>
                  <th class="px-3 py-2 text-left">CLQ Name</th>
                  <th class="px-3 py-2 text-left">State</th>
                  <th class="px-3 py-2 text-right">Score</th>
                  <th class="px-3 py-2 text-center">Risk Level</th>
                  <th class="px-3 py-2 text-center">Action</th>
                </tr>
              </thead>
              <tbody id="clqTableBody" class="divide-y divide-gray-100">
                <!-- rows injected -->
              </tbody>	 
            </table>
			<div class="flex items-center justify-between mt-4">
			  <div class="text-sm text-gray-500" id="pagingInfo">
				Showing - to - of -
			  </div>

			  <div class="flex items-center gap-2">
				<button id="btnPrev"
				  class="px-3 py-1.5 text-sm rounded border bg-white hover:bg-gray-50 disabled:opacity-50"
				  disabled>
				  Prev
				</button>

				<select id="pageSize"
				  class="border rounded px-2 py-1 text-sm bg-white">
				  <option value="5">5 / page</option>
				  <option value="10" selected>10 / page</option>
				  <option value="20">20 / page</option>
				</select>

				<button id="btnNext"
				  class="px-3 py-1.5 text-sm rounded border bg-white hover:bg-gray-50">
				  Next
				</button>
			  </div>
			</div>			  			
          </div>
        </div>

        <!-- Detail Panel -->
        <div class="bg-white rounded-lg shadow-sm p-4 space-y-3">
          <h3 class="text-sm font-semibold text-gray-800 mb-1">CLQ Risk Profile</h3>
          <p class="text-xs text-gray-500 mb-3">
            Click <span class="font-semibold">‚ÄúView‚Äù</span> in the list to see risk details and recommended actions.
          </p>

          <div class="border rounded-lg p-3 bg-gray-50">
            <p class="text-xs text-gray-500">CLQ Name</p>
            <p id="detailName" class="text-sm font-semibold text-gray-800">-</p>
            <!-- <p id="detailEmployer" class="text-xs text-gray-500">Operator/Employer: -</p> -->
            <p id="detailState" class="text-xs text-gray-500">State: -</p>

            <div class="mt-2 flex items-center space-x-2">
              <span id="detailRiskBadge"
                    class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-gray-200 text-gray-700">
                RISK LEVEL
              </span>
              <span id="detailRiskScore" class="text-xs text-gray-500">Risk Score: -</span>
            </div>
          </div>

          <div class="border rounded-lg p-3">
            <p class="text-xs font-semibold text-gray-700 mb-2">Risk Score Breakdown (Model Contribution)</p>
            <ul id="detailBreakdown" class="text-xs text-gray-600 space-y-1">
              <li>-</li>
            </ul>
          </div>

          <div class="border rounded-lg p-3">
            <p class="text-xs font-semibold text-gray-700 mb-2">Key Signals</p>
            <ul id="detailSignals" class="text-xs text-gray-600 space-y-1">
              <li>-</li>
            </ul>
          </div>

          <div class="border rounded-lg p-3">
            <p class="text-xs font-semibold text-gray-700 mb-2">Recommended Action</p>
            <p id="detailRecommendation" class="text-xs text-gray-600 mb-3">-</p>

            <div class="flex flex-wrap gap-2">
              <button class="bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-700">
                Schedule Investigation
              </button>
              <button class="bg-orange-500 text-white text-xs px-3 py-1 rounded hover:bg-orange-600">
                Issue Compliance Notice
              </button>
            </div>
          </div>

          <div class="text-[11px] text-gray-500">
            Note: Risk scoring supports prioritisation. Enforcement actions require officer verification.
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
// ===============================
// CSV LOAD (GitHub Pages)
// ===============================
let clqData = [];
let currentView = [];

// 2) CSV parser (handles quotes)
function parseCsv(line) {
  const out = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const ch = line[i];

    if (ch === '"') {
      if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (ch === "," && !inQuotes) {
      out.push(cur.trim()); cur = "";
    } else {
      cur += ch;
    }
  }
  out.push(cur.trim());
  return out;
}


// ===============================
// CSV PARSER (comma delimiter, handles quotes)
// ===============================
function parseCsvLine(line) {
  const out = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (ch === "," && !inQuotes) {
      out.push(cur.trim()); cur = "";
    } else {
      cur += ch;
    }
  }
  out.push(cur.trim());
  return out;
}

const CSV_URL = "https://hildaeda.github.io/emerging_project/clq_registry.csv";

fetch(CSV_URL + "?v=" + Date.now())
  .then(res => {
    if (!res.ok) throw new Error("CSV HTTP " + res.status);
    return res.text();
  })
  .then(csvText => {
    const rows = csvToObjects(csvText);

    // IMPORTANT: assign to GLOBAL clqData (jangan "const clqData" lagi)
    clqData = rows.map((r, idx) => {
      const { score, riskLevel, triggerApplied } = calcRisk3(r);

      return {
        id: idx + 1,
        name: (r.clqName || "-").trim(),
        state: (r.state || "-").trim().toUpperCase(),
        complaints60d: Number(r.complaints60d || 0),
        pastViolations: Number(r.pastViolations || 0),
        daysSinceLastInspection: Number(r.daysSinceLastInspection || 0),

        // UI bawah awak guna "riskScore", bukan "score"
        riskScore: score,
        riskLevel,
        triggerApplied,

        breakdown: [
          `Complaints (60d): ${Number(r.complaints60d || 0)}`,
          `Past violations: ${Number(r.pastViolations || 0)}`,
          `Days since last inspection: ${Number(r.daysSinceLastInspection || 0)}`,
          `Violation trigger applied: ${triggerApplied ? "Yes (" + triggerApplied + ")" : "No"}`
        ],
        signals: [],
        recommendation:
          riskLevel === "High"
            ? "Recommended to prioritise investigation within 30 days."
            : riskLevel === "Medium"
            ? "Monitor closely and schedule investigation if signals increase."
            : "Low-risk profile. Continue routine monitoring."
      };
    });

    // Lepas data siap, barulah render
    currentPage = 1;
    currentView = [...clqData].sort((a, b) => b.riskScore - a.riskScore);

    renderSummary(currentView);
    renderTablePaged(currentView);
    resetDetail();
  })
  .catch(err => {
    console.error("CSV/JS error:", err);
    alert("Error: " + err.message);
  });


function csvToObjects(csvText) {
  const lines = csvText.trim().split(/\r?\n/).filter(Boolean);
  const headers = parseCsvLine(lines[0]);

  return lines.slice(1).map(line => {
    const cols = parseCsvLine(line);
    const obj = {};
    headers.forEach((h, i) => obj[h] = cols[i] || "");
    return obj;
  });
}

// 3) Demo: generate a risk score & risk level (replace later with real model)

function clamp01(x) { return Math.max(0, Math.min(1, x)); }

// Normalise to 0..1 (explainable)
function normComplaints(c) { return clamp01(c / 30); }        // 0..30+ complaints
function normViolations(v) { return clamp01(v / 6); }         // 0..6+ violations
function normDays(days)    { return clamp01(days / 720); }    // 0..720+ days

function calcRisk3(row) {
  const c = Number(row.complaints60d || 0);
  const v = Number(row.pastViolations || 0);
  const d = Number(row.daysSinceLastInspection || 0);

  // üö® Policy trigger rules (realistic for enforcement)
  if (v >= 6) return { score: 90, riskLevel: "High", triggerApplied: "Violations ‚â• 6" };
  if (v >= 3 && c >= 10) return { score: 85, riskLevel: "High", triggerApplied: "Violations ‚â• 3 & Complaints ‚â• 10" };
  if (v >= 3 && d >= 360) return { score: 80, riskLevel: "High", triggerApplied: "Violations ‚â• 3 & Days since last inspection ‚â• 360" };

  // Weighted score (ranking)
  const wC = 0.35, wV = 0.45, wD = 0.20;
  const s = (wC * normComplaints(c)) + (wV * normViolations(v)) + (wD * normDays(d));

  const score = Math.round(s * 100);
  const riskLevel = score >= 75 ? "High" : score >= 50 ? "Medium" : "Low";
  return { score, riskLevel, triggerApplied: null };
}


// 4) Build clqData from CSV (this replaces the hardcoded array)
 
    function getRiskBadgeClass(level) {
      switch (level) {
        case "High":   return "bg-red-100 text-red-700";
        case "Medium": return "bg-orange-100 text-orange-700";
        case "Low":    return "bg-green-100 text-green-700";
        default:       return "bg-gray-200 text-gray-700";
      }
    }

    function renderSummary(data) {
      const total = data.length;
      const high = data.filter(d => d.riskLevel === "High").length;
      const totalComplaints = data.reduce((sum, d) => sum + d.complaints60d, 0);

      document.getElementById("cardTotalClq").textContent = total;
      document.getElementById("cardHighRisk").textContent = high;
      document.getElementById("cardComplaints").textContent = totalComplaints;
    }

    function renderDetail(clq) {
      document.getElementById("detailName").textContent = clq.name;
      document.getElementById("detailState").textContent = "State: " + clq.state;
      document.getElementById("detailRiskScore").textContent = "Risk Score: " + clq.riskScore + " / 100";

      const badge = document.getElementById("detailRiskBadge");
      badge.textContent = clq.riskLevel.toUpperCase() + " RISK";
      badge.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold " + getRiskBadgeClass(clq.riskLevel);

      const breakdownList = document.getElementById("detailBreakdown");
      breakdownList.innerHTML = "";
      clq.breakdown.forEach(item => {
        const li = document.createElement("li");
        li.textContent = "‚Ä¢ " + item;
        breakdownList.appendChild(li);
      });

      const signalsList = document.getElementById("detailSignals");
      signalsList.innerHTML = "";
      clq.signals.forEach(sig => {
        const li = document.createElement("li");
        li.textContent = "‚Ä¢ " + sig;
        signalsList.appendChild(li);
      });

      document.getElementById("detailRecommendation").textContent = clq.recommendation;
    }

	function updatePagingUI(totalItems) {
	  const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
	  currentPage = Math.min(currentPage, totalPages);

	  const start = (currentPage - 1) * pageSize + 1;
	  const end = Math.min(totalItems, currentPage * pageSize);

	  document.getElementById("pagingInfo").textContent =
		`Showing ${totalItems === 0 ? 0 : start} to ${end} of ${totalItems}`;

	  document.getElementById("btnPrev").disabled = (currentPage <= 1);
	  document.getElementById("btnNext").disabled = (currentPage >= totalPages);
	}

	function renderTablePaged(data) {
	  const tbody = document.getElementById("clqTableBody"); // pastikan id ni sama
	  tbody.innerHTML = "";

	  const totalItems = data.length;
	  updatePagingUI(totalItems);

	  const startIdx = (currentPage - 1) * pageSize;
	  const pageItems = data.slice(startIdx, startIdx + pageSize);

	  pageItems.forEach((clq, index) => {
		const rowNo = startIdx + index + 1;

		const tr = document.createElement("tr");
		tr.className = "hover:bg-gray-50";

		tr.innerHTML = `
		  <td class="px-3 py-2 text-left text-gray-500">${rowNo}</td>
		  <td class="px-3 py-2 text-left">
			<p class="font-medium text-gray-800">${clq.name}</p>
		  </td>
		  <td class="px-3 py-2 text-left text-gray-600">${clq.state}</td>
		  <td class="px-3 py-2 text-right font-semibold text-gray-800">${clq.riskScore}</td>
		  <td class="px-3 py-2 text-center">
			<span class="inline-flex px-2 py-0.5 rounded-full text-[10px] font-semibold ${getRiskBadgeClass(clq.riskLevel)}">
			  ${clq.riskLevel.toUpperCase()}
			</span>
		  </td>
		  <td class="px-3 py-2 text-center text-gray-700">${clq.complaints60d ?? 0}</td>
		  <td class="px-3 py-2 text-center">
			<button class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
			  data-id="${clq.id}">
			  View
			</button>
		  </td>
		`;
		tbody.appendChild(tr);
	  });

	  // re-bind view buttons
	  tbody.querySelectorAll("button[data-id]").forEach(btn => {
		btn.addEventListener("click", () => {
		  const id = Number(btn.getAttribute("data-id"));
		  const selected = currentView.find(c => c.id === id);
		  if (selected) renderDetail(selected);
		});
	  });
	}


    function resetDetail() {
      document.getElementById("detailName").textContent = "-";
      //document.getElementById("detailEmployer").textContent = "Operator/Employer: -";
      document.getElementById("detailState").textContent = "State: -";
      document.getElementById("detailRiskScore").textContent = "Risk Score: -";

      document.getElementById("detailBreakdown").innerHTML = "<li>-</li>";
      document.getElementById("detailSignals").innerHTML = "<li>-</li>";
      document.getElementById("detailRecommendation").textContent = "-";

      const badge = document.getElementById("detailRiskBadge");
      badge.textContent = "RISK LEVEL";
      badge.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-gray-200 text-gray-700";
    }

    function applyFilter() {
      const state = document.getElementById("filterState").value;
      const risk  = document.getElementById("filterRisk").value;

      let filtered = [...clqData];
      if (state) filtered = filtered.filter(c => c.state === state);
      if (risk)  filtered = filtered.filter(c => c.riskLevel === risk);

      renderSummary(filtered);
      resetDetail();
	  currentPage = 1;
	  currentView = filtered.sort((a, b) => b.riskScore - a.riskScore);
	  renderTablePaged(currentView);	  
    }

	let currentPage = 1;
	let pageSize = 10;

	document.addEventListener("DOMContentLoaded", () => {
	  // initial view
	  currentView = [...clqData].sort((a, b) => b.riskScore - a.riskScore);

	  renderSummary(currentView);
	  renderTablePaged(currentView);
	  resetDetail();

	  document.getElementById("btnApplyFilter").addEventListener("click", applyFilter);

	  document.getElementById("btnPrev").addEventListener("click", () => {
		if (currentPage > 1) {
		  currentPage--;
		  renderTablePaged(currentView);
		}
	  });

	  document.getElementById("btnNext").addEventListener("click", () => {
		const totalPages = Math.max(1, Math.ceil(currentView.length / pageSize));
		if (currentPage < totalPages) {
		  currentPage++;
		  renderTablePaged(currentView);
		}
	  });

	  document.getElementById("pageSize").addEventListener("change", (e) => {
		pageSize = Number(e.target.value);
		currentPage = 1;
		renderTablePaged(currentView);
	  });
	});


  </script>
</body>
</html>
